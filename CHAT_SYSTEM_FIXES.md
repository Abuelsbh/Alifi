# ๐ฉบ ุฅุตูุงุญุงุช ูุธุงู ุงูุฏุฑุฏุดุฉ ุงูุจูุทุฑูุฉ - ููุชูู

## ุงููุดููุฉ ุงูุฃุตููุฉ

ูุงูุช ููุงู ูุดููุฉ ูู ูุธุงู ุงูุฏุฑุฏุดุฉ ุญูุซ ุฃู ุงูุฃุทุจุงุก ุงูุจูุทุฑููู ูุง ูุฑูู ุงููุญุงุฏุซุงุช ุงูุฌุฏูุฏุฉ ูู ุงููุณุชุฎุฏููู ุจุณุจุจ ูุดุงูู ูู:

1. **ุชุญุฏูุซ ุนุฏุงุฏ ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ** - ูู ููู ูุชู ุชุญุฏูุซ ุนุฏุงุฏ ุงูุทุจูุจ ุงูุจูุทุฑู ุนูุฏ ุฅุฑุณุงู ุฑุณุงุฆู ุฌุฏูุฏุฉ
2. **ุนุฏู ุชุญุฏูุฏ ุงูุฑุณุงุฆู ูููุฑูุกุฉ** - ุนุฏู ุงุณุชุฎุฏุงู ุฏุงูุฉ `markMessagesAsRead` ูู ุตูุญุงุช ุงูุฏุฑุฏุดุฉ
3. **ุขููุฉ ุชุญุฏูุซ ุงูุนุฏุงุฏุงุช** - ูุงูุช ุชุญุฏุซ ุนุฏุงุฏ ุงููุฑุณู ููุท ูููุณ ุงููุณุชูุจู

## โ ุงูุฅุตูุงุญุงุช ุงููุทุจูุฉ

### 1. **ุฅุตูุงุญ ุฏุงูุฉ `sendTextMessage`**

**ูุจู ุงูุฅุตูุงุญ:**
```dart
// ูุงูุช ุชุญุฏุซ ุงููุฑุณู ููุท
batch.update(chatRef, {
  'unreadCount.$senderId': 0,
});
```

**ุจุนุฏ ุงูุฅุตูุงุญ:**
```dart
// ุงูุขู ุชุญุฏุซ ููุง ูู ุงููุฑุณู ูุงููุณุชูุจู
// First, get the chat document to know the participants
final chatDoc = await _firestore.collection('veterinary_chats').doc(chatId).get();
final participants = List<String>.from(chatData['participants'] ?? []);
final currentUnreadCount = Map<String, dynamic>.from(chatData['unreadCount'] ?? {});

// Find the other participant (receiver)
String? receiverId;
for (String participant in participants) {
  if (participant != senderId) {
    receiverId = participant;
    break;
  }
}

// Prepare updated unread counts
Map<String, dynamic> updatedUnreadCounts = Map<String, dynamic>.from(currentUnreadCount);

// Reset sender's unread count to 0
updatedUnreadCounts[senderId] = 0;

// Increment receiver's unread count
if (receiverId != null) {
  updatedUnreadCounts[receiverId] = (updatedUnreadCounts[receiverId] ?? 0) + 1;
}

batch.update(chatRef, {
  'unreadCount': updatedUnreadCounts,
});
```

### 2. **ุฅุตูุงุญ ุฏุงูุฉ `sendImageMessage`**

ุชู ุชุทุจูู ููุณ ุงูุฅุตูุงุญ ุนูู ุฏุงูุฉ ุฅุฑุณุงู ุงูุตูุฑ ูุถูุงู ุชุญุฏูุซ ุงูุนุฏุงุฏุงุช ุจุดูู ุตุญูุญ.

### 3. **ุฅุถุงูุฉ `markMessagesAsRead` ูู ุตูุญุงุช ุงูุฏุฑุฏุดุฉ**

#### ูู `EnhancedChatScreen`:
```dart
Future<void> _loadMessages() async {
  // Mark messages as read when entering chat
  final userId = AuthService.userId;
  if (userId != null) {
    await ChatService.markMessagesAsRead(
      chatId: widget.chatId,
      userId: userId,
    );
  }
  
  // Listen to real-time messages
  _messagesSubscription = ChatService.getChatMessagesStream(widget.chatId).listen((messages) {
    // Mark messages as read when new messages arrive
    final userId = AuthService.userId;
    if (userId != null) {
      ChatService.markMessagesAsRead(
        chatId: widget.chatId,
        userId: userId,
      );
    }
  });
}
```

#### ูู `RealTimeChatScreen`:
ุชู ุชุทุจูู ููุณ ุงูุฅุตูุงุญ.

## ๐ ุงูุจููุฉ ุงูุชูููุฉ ุงูููุญุฏุซุฉ

### ูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช:
```
veterinary_chats/
โโโ {chatId}/
โ   โโโ participants: [userId, veterinarianId]
โ   โโโ participantNames: {userId: "name", vetId: "name"}
โ   โโโ lastMessage: "ุขุฎุฑ ุฑุณุงูุฉ"
โ   โโโ lastMessageAt: timestamp
โ   โโโ lastMessageSender: userId
โ   โโโ unreadCount: {
โ   โ   userId: 0,
โ   โ   veterinarianId: 2  // โ ูุชู ุชุญุฏูุซู ุจุดูู ุตุญูุญ ุงูุขู
โ   โ }
โ   โโโ isActive: true
โ   โโโ messages/
โ       โโโ {messageId1}/
โ       โโโ {messageId2}/
โ       โโโ ...
```

### ุขููุฉ ุงูุชุญุฏูุซ ุงูุฌุฏูุฏุฉ:

1. **ุนูุฏ ุฅุฑุณุงู ุฑุณุงูุฉ:**
   - โ ุชุญุฏูุฏ ุงููุฑุณู ูุงููุณุชูุจู ูู `participants` array
   - โ ุนุฏุงุฏ ุงููุฑุณู = 0 (ุฑุขูุง)
   - โ ุนุฏุงุฏ ุงููุณุชูุจู = +1 (ุฑุณุงูุฉ ุฌุฏูุฏุฉ)
   - โ ุชุญุฏูุซ `lastMessage` ู `lastMessageAt`

2. **ุนูุฏ ูุชุญ ุงููุญุงุฏุซุฉ:**
   - โ ุงุณุชุฏุนุงุก `markMessagesAsRead` ุชููุงุฆูุงู
   - โ ุชุญุฏูุซ ุฌููุน ุฑุณุงุฆู ุงููุณุชูุจู ุฅูู `isRead: true`
   - โ ุชุตููุฑ ุนุฏุงุฏ ุงููุณุชุฎุฏู ุงูุญุงูู

3. **ุงูุนุฑุถ ูู ุงูููุช ุงููุนูู:**
   - โ `getUnreadMessageCountStream` ููุนุฏุงุฏ ุงูุฅุฌูุงูู
   - โ `getUserChatsStream` ูููุณุชุฎุฏููู
   - โ `getVeterinarianChatsStream` ููุฃุทุจุงุก ุงูุจูุทุฑููู

## ๐ ุชุฏูู ุงูุฑุณุงุฆู ุงูููุญุฏุซ

### ูููุณุชุฎุฏู ุงูุนุงุฏู:
1. **ุฅูุดุงุก ูุญุงุฏุซุฉ** โ `ChatService.createChatWithVet()` โ
2. **ุฅุฑุณุงู ุฑุณุงูุฉ** โ `ChatService.sendTextMessage()` โ 
3. **ุชุญุฏูุซ ุงูุนุฏุงุฏ** โ ุนุฏุงุฏ ุงูุทุจูุจ +1 โ
4. **ูุชุญ ุงููุญุงุฏุซุฉ** โ `markMessagesAsRead()` โ

### ููุทุจูุจ ุงูุจูุทุฑู:
1. **ุฑุคูุฉ ุงููุญุงุฏุซุงุช** โ `VeterinaryService.getVeterinarianChatsStream()` โ
2. **ุฑุคูุฉ ุงูุนุฏุงุฏ** โ `unreadCount[vetId]` โ ูุญุฏุซ ุจุดูู ุตุญูุญ
3. **ูุชุญ ุงููุญุงุฏุซุฉ** โ `markMessagesAsRead()` โ
4. **ุงูุฑุฏ ุนูู ุงููุฑูุถ** โ ุชุญุฏูุซ ุนุฏุงุฏ ุงููุฑูุถ โ

## ๐ฏ ุงููุชุงุฆุฌ ุงููุชููุนุฉ

ุจุนุฏ ูุฐู ุงูุฅุตูุงุญุงุช:

- โ **ุงูุฃุทุจุงุก ุงูุจูุทุฑููู ุณูุฑูู ุงููุญุงุฏุซุงุช ุงูุฌุฏูุฏุฉ ููุฑุงู**
- โ **ุนุฏุงุฏุงุช ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ ุชุนูู ุจุดูู ุตุญูุญ**
- โ **ุงูุชุญุฏูุซ ูู ุงูููุช ุงููุนูู ูููุง ุงูุทุฑููู**
- โ **ุชุฒุงูู ุตุญูุญ ููุจูุงูุงุช ุจูู ุฌููุน ุงูุฃุฌูุฒุฉ**
- โ **ุนุฏู ููุฏุงู ุงูุฑุณุงุฆู ุฃู ุงููุญุงุฏุซุงุช**

## ๐ ุงูุชุญูู ูู ุงูุฅุตูุงุญ

ููุชุฃูุฏ ูู ุฃู ุงูุฅุตูุงุญ ูุนูู:

1. **ุฃูุดุฆ ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ** ูู ุญุณุงุจ ูุณุชุฎุฏู ุนุงุฏู
2. **ุฃุฑุณู ุฑุณุงูุฉ** ููุทุจูุจ ุงูุจูุทุฑู  
3. **ุงูุชุญ ุชุทุจูู ุงูุทุจูุจ** ูุชุฃูุฏ ูู:
   - ุธููุฑ ุงููุญุงุฏุซุฉ ูู ูุงุฆูุฉ ุงููุญุงุฏุซุงุช โ
   - ุธููุฑ ุนุฏุงุฏ ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ โ
   - ุชุญุฏูุซ `lastMessage` ู `lastMessageAt` โ
4. **ุงูุชุญ ุงููุญุงุฏุซุฉ** ูู ุญุณุงุจ ุงูุทุจูุจ ูุชุฃูุฏ ูู:
   - ุชุตููุฑ ุงูุนุฏุงุฏ ุชููุงุฆูุงู โ
   - ุนุฑุถ ุฌููุน ุงูุฑุณุงุฆู โ
   - ุฅููุงููุฉ ุงูุฑุฏ ุจุดูู ุทุจูุนู โ

## ๐ ุงูุชุญุณููุงุช ุงูุฅุถุงููุฉ

ูุฐู ุงูุฅุตูุงุญุงุช ุชุถูู:

- **ุฃุฏุงุก ูุญุณู** - ุชุญุฏูุซ ุงูุนุฏุงุฏุงุช ุจููุงุกุฉ
- **ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃูุถู** - ุฑุคูุฉ ููุฑูุฉ ููุฑุณุงุฆู ุงูุฌุฏูุฏุฉ
- **ููุซูููุฉ ุนุงููุฉ** - ุนุฏู ููุฏุงู ุฃู ุฑุณุงุฆู
- **ุชุฒุงูู ูุซุงูู** - ุนูู ุงููุธุงู ุนูู ุฌููุน ุงูุฃุฌูุฒุฉ
- **ูุงุจููุฉ ุงูุชูุณุน** - ุงูุจููุฉ ุฌุงูุฒุฉ ููููุฒุงุช ูุณุชูุจููุฉ

**ุชู ุฅุตูุงุญ ูุธุงู ุงูุฏุฑุฏุดุฉ ุจุงููุงูู! ๐** 